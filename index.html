<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTP Companion</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --red: #c94a4a;
            --red-dark: #a33a3a;
            --red-light: #e07070;
            --cream: #faf5f0;
            --cream-dark: #f0e8e0;
            --gold: #d4a84b;
        }
        
        body {
            font-family: Georgia, 'Times New Roman', serif;
            background: var(--cream);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--red-dark) 0%, var(--red) 100%);
            color: var(--cream);
            padding: 1rem;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 1.25rem;
            font-weight: normal;
            letter-spacing: 0.05em;
            text-align: center;
        }
        
        .header-subtitle {
            font-size: 0.75rem;
            text-align: center;
            opacity: 0.8;
            margin-top: 0.25rem;
        }
        
        /* CLASS SELECTOR - Horizontal scroll on mobile */
        .class-selector {
            background: var(--cream-dark);
            border-bottom: 1px solid #ddd;
            padding: 0.75rem 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .class-chips {
            display: flex;
            gap: 0.5rem;
            padding: 0 1rem;
            min-width: max-content;
        }
        
        .class-chip {
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .class-chip:hover {
            border-color: var(--red);
        }
        
        .class-chip.active {
            background: var(--red);
            color: white;
            border-color: var(--red);
        }
        
        .class-chip .chip-date {
            font-weight: bold;
        }
        
        .class-chip .chip-topic {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-left: 0.25rem;
        }
        
        /* MAIN CONTENT */
        .main {
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* CLASS HEADER */
        .class-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }
        
        .class-date {
            font-size: 0.9rem;
            color: var(--red);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .class-title {
            font-size: 1.5rem;
            color: #222;
            margin-top: 0.25rem;
        }
        
        /* SECTION CARDS */
        .section {
            background: white;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .section-header {
            background: var(--cream-dark);
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--red);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header .toggle {
            font-size: 1.25rem;
            color: var(--red);
        }
        
        .section-content {
            padding: 1rem;
        }
        
        .section-content.collapsed {
            display: none;
        }
        
        /* PRACTICE SECTION - Special styling */
        .section.practice {
            border: 2px solid var(--red);
        }
        
        .section.practice .section-header {
            background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
            color: white;
        }
        
        .section.practice .toggle {
            color: white;
        }
        
        .practice-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.75rem;
        }
        
        .practice-steps {
            list-style: none;
        }
        
        .practice-steps li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .practice-steps li:last-child {
            border-bottom: none;
        }
        
        .practice-steps li::before {
            content: "‚óÜ";
            position: absolute;
            left: 0;
            color: var(--red);
            font-size: 0.6rem;
            top: 0.7rem;
        }
        
        .practice-quote {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            padding-left: 1rem;
            border-left: 2px solid var(--red-light);
        }
        
        /* COMMENTARY SECTION */
        .commentary-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        .commentary-point {
            margin-bottom: 1.25rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .commentary-point:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .commentary-point h4 {
            color: #333;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .commentary-point p {
            font-size: 1rem;
            color: #444;
            margin-bottom: 0.5rem;
        }
        
        .commentary-point p:last-child {
            margin-bottom: 0;
        }
        
        .kk-quote {
            font-style: italic;
            color: #555;
            background: var(--cream);
            padding: 0.75rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .kk-quote::before {
            content: """;
            color: var(--red);
            font-size: 1.5rem;
            line-height: 0;
            vertical-align: -0.3rem;
            margin-right: 0.25rem;
        }
        
        .kk-quote::after {
            content: "" ‚Äî KK";
            color: var(--red);
        }
        
        /* ROOT TEXT SECTIONS */
        .root-text-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--red);
            margin-bottom: 0.5rem;
        }
        
        .root-text-title {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.75rem;
        }
        
        .root-text-content {
            font-size: 1rem;
            line-height: 1.8;
            color: #444;
            background: var(--cream);
            padding: 1rem;
            border-radius: 4px;
            border-left: 3px solid var(--red);
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            text-indent: 0;
        }
        
        .root-text-content p {
            margin-bottom: 1rem;
        }
        
        .root-text-content p:last-child {
            margin-bottom: 0;
        }
        
        .root-text-content .mtb-inline-header {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--red-dark);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
        }
        
        .root-text-content .mtb-inline-header:first-child {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }
        
        /* PREVIEW SECTION - bold style */
        .section.preview .section-header {
            background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
            color: white;
        }
        
        .section.preview .toggle {
            color: var(--red-light);
        }
        
        /* TRANSCRIPT SECTION - light style */
        .section.transcript .section-header {
            background: var(--cream-dark);
            color: var(--red);
        }
        
        .section.transcript .toggle {
            color: var(--red);
        }
        
        /* RECORDING SECTION - light style */
        .section.recording .section-header {
            background: var(--cream-dark);
            color: var(--red);
        }
        
        .section.recording .toggle {
            color: var(--red);
        }
        
        .recording-link {
            display: inline-block;
            padding: 0.75rem 1.25rem;
            background: linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .recording-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 74, 74, 0.3);
        }
        
        .transcript-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .transcript-session {
            margin-bottom: 1.5rem;
        }
        
        .transcript-session-title {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--red);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--cream-dark);
        }
        
        .transcript-segment {
            margin-bottom: 1rem;
            padding-left: 0.75rem;
            border-left: 3px solid #e0d8e8;
        }
        
        .transcript-segment.kk {
            border-left-color: var(--red);
            background: linear-gradient(90deg, rgba(201, 74, 74, 0.05) 0%, transparent 100%);
            padding: 0.5rem 0.75rem;
            margin-left: -0.75rem;
            border-radius: 0 4px 4px 0;
        }
        
        .transcript-meta {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.25rem;
        }
        
        .transcript-speaker {
            font-weight: 600;
            color: #555;
        }
        
        .transcript-segment.kk .transcript-speaker {
            color: var(--red);
        }
        
        .transcript-time {
            color: #aaa;
            margin-left: 0.5rem;
        }
        
        .transcript-text {
            font-size: 1rem;
            line-height: 1.7;
            color: #444;
        }
        
        .transcript-prayers {
            background: var(--cream);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-style: italic;
            color: #666;
        }
        
        .transcript-prayers-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #888;
            font-style: normal;
            margin-bottom: 0.5rem;
        }
        
        .transcript-prayers-note {
            font-size: 0.85rem;
            color: #777;
        }
        
        .transcript-subsection-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #555;
            margin: 1.5rem 0 0.75rem 0;
            padding: 0.5rem 0.25rem;
            border-bottom: 1px solid var(--cream-dark);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transcript-subsection-title:hover {
            background: #f8f6fa;
        }
        
        .transcript-subsection-title .toggle {
            font-size: 1rem;
            color: #aaa;
        }
        
        .transcript-subsection-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .transcript-subsection-content:not(.collapsed) {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .transcript-subsection-content.collapsed {
            max-height: 0;
        }
        
        .transcript-prayers-wrapper {
            cursor: pointer;
        }
        
        .transcript-prayers-wrapper:hover .transcript-prayers {
            background: #f5f0e8;
        }
        
        .transcript-prayers {
            background: var(--cream);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .transcript-prayers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transcript-prayers-header .toggle {
            font-size: 1rem;
            color: #aaa;
        }
        
        .transcript-loading {
            text-align: center;
            padding: 2rem;
            color: #888;
        }
        
        .transcript-unavailable {
            text-align: center;
            padding: 2rem;
            color: #999;
            font-style: italic;
        }
        
        /* LOADING STATE */
        .loading {
            text-align: center;
            padding: 3rem 1rem;
            color: #888;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--cream-dark);
            border-top-color: var(--red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ERROR STATE */
        .error {
            text-align: center;
            padding: 3rem 1rem;
            color: #c62828;
        }
        
        .error-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .error p {
            margin-bottom: 1rem;
        }
        
        .error code {
            display: block;
            background: #ffebee;
            padding: 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            text-align: left;
            overflow-x: auto;
        }
        
        /* NO CONTENT */
        .no-content {
            color: #888;
            font-style: italic;
            padding: 1rem;
            text-align: center;
        }
        
        /* RESPONSIVE - Larger screens */
        @media (min-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .class-chips {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .main {
                padding: 1.5rem;
                padding-bottom: 30vh;
            }
            
            .class-title {
                font-size: 1.75rem;
            }
            
            .root-text-content {
                max-height: 700px;
                font-size: 1.05rem;
            }
            
            .transcript-container {
                max-height: 700px;
            }
        }
        
        /* Mobile: allow scrolling past last section */
        @media (max-width: 767px) {
            .main {
                padding-bottom: 30vh;
            }
            
            .root-text-content {
                max-height: 500px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Teacher Training Program</h1>
        <div class="header-subtitle">KMC Brooklyn ¬∑ Meaningful to Behold</div>
    </header>
    
    <nav class="class-selector">
        <div class="class-chips" id="classChips">
            <!-- Classes will be inserted here -->
        </div>
    </nav>
    
    <main class="main" id="mainContent">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading classes...</p>
        </div>
    </main>

    <script>
        let classesData = [];
        let currentClassId = null;
        let textsCache = {}; // Cache for MTB and Shantideva texts
        
        // Load data from manifest and individual class files
        async function loadData() {
            try {
                // First, load the manifest to get list of class IDs
                const manifestResponse = await fetch('classes/manifest.json?v=' + Date.now());
                if (!manifestResponse.ok) {
                    throw new Error(`Could not load manifest: ${manifestResponse.status}`);
                }
                const manifest = await manifestResponse.json();
                
                if (!manifest.classes || manifest.classes.length === 0) {
                    showError('No classes found in manifest.');
                    return;
                }
                
                // Load all class files in parallel
                const classPromises = manifest.classes.map(async (classId) => {
                    const response = await fetch(`classes/${classId}.json?v=` + Date.now());
                    if (!response.ok) {
                        console.warn(`Could not load class ${classId}`);
                        return null;
                    }
                    return response.json();
                });
                
                const loadedClasses = await Promise.all(classPromises);
                classesData = loadedClasses.filter(c => c !== null);
                
                if (classesData.length > 0) {
                    currentClassId = classesData[classesData.length - 1].id; // Start with most recent
                    renderChips();
                    renderContent();
                    // Scroll the class selector to the right to show the latest class
                    const selector = document.querySelector('.class-selector');
                    selector.scrollLeft = selector.scrollWidth;
                } else {
                    showError('No classes could be loaded.');
                }
            } catch (error) {
                showError(`Could not load class data.\n\nError: ${error.message}`);
            }
        }
        
        // Load MTB text sections on demand
        async function loadMTBText() {
            if (textsCache.mtb) return textsCache.mtb;
            try {
                console.log('Fetching MTB text from texts/mtb-sections.json...');
                const response = await fetch('texts/mtb-sections.json');
                console.log('MTB fetch response:', response.status, response.ok);
                if (response.ok) {
                    textsCache.mtb = await response.json();
                    console.log('MTB loaded, sections:', Object.keys(textsCache.mtb.sections).length);
                    return textsCache.mtb;
                }
            } catch (e) {
                console.warn('Could not load MTB text:', e);
            }
            return null;
        }
        
        // Load Shantideva text on demand
        async function loadShantidevaText() {
            if (textsCache.shantideva) return textsCache.shantideva;
            try {
                console.log('Fetching Shantideva text from texts/shantideva.json...');
                const response = await fetch('texts/shantideva.json');
                console.log('Shantideva fetch response:', response.status, response.ok);
                if (response.ok) {
                    textsCache.shantideva = await response.json();
                    return textsCache.shantideva;
                }
            } catch (e) {
                console.warn('Could not load Shantideva text:', e);
            }
            return null;
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="error">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <p><strong>Error loading data</strong></p>
                    <code>${message}</code>
                </div>
            `;
        }
        
        // Render class chips
        function renderChips() {
            const container = document.getElementById('classChips');
            container.innerHTML = classesData.map(c => `
                <button class="class-chip ${c.id === currentClassId ? 'active' : ''}" 
                        onclick="selectClass('${c.id}')"
                        data-topic="${c.topic.toLowerCase()}"
                        data-date="${c.date.toLowerCase()}">
                    <span class="chip-date">${c.date}</span>
                    <span class="chip-topic">¬∑ ${c.topic}</span>
                </button>
            `).join('');
        }
        
        // Select a class
        function selectClass(id) {
            currentClassId = id;
            renderChips();
            renderContent();
            // Scroll to top of page
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Toggle section collapse
        function toggleSection(el) {
            const content = el.nextElementSibling;
            const toggle = el.querySelector('.toggle');
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '‚àí';
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '+';
            }
        }
        
        // Toggle MTB section with lazy loading from references
        async function toggleMTBSection(el, classId) {
            const content = el.nextElementSibling;
            const toggle = el.querySelector('.toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '‚àí';
                
                // Load content if not already loaded
                if (content.dataset.mtbLoaded !== 'true') {
                    const cls = classesData.find(c => c.id === classId);
                    const container = document.getElementById(`mtb-content-${classId}`);
                    
                    // If content already embedded, mark as loaded
                    if (cls.mtb?.content) {
                        content.dataset.mtbLoaded = 'true';
                        return;
                    }
                    
                    // Load from references
                    const mtbData = await loadMTBText();
                    if (!mtbData) {
                        container.innerHTML = '<p class="no-content">Could not load text</p>';
                        content.dataset.mtbLoaded = 'true';
                        return;
                    }
                    
                    let html = '';
                    let autoTitle = '';
                    
                    // Simplest format: just startParagraph and endParagraph
                    if (cls.mtb?.startParagraph && !cls.mtb?.ranges && !cls.mtb?.sections) {
                        const start = cls.mtb.startParagraph;
                        const end = cls.mtb.endParagraph || start;
                        console.log('Simple paragraph range:', start, 'to', end);
                        
                        // Build ordered list of paragraphs with their sections
                        const paragraphsInRange = [];
                        for (const [slug, section] of Object.entries(mtbData.sections)) {
                            for (const p of section.paragraphs) {
                                if (p.id >= start && p.id <= end) {
                                    // Check if this is the first paragraph of the section
                                    const isFirstOfSection = section.paragraphs[0]?.id === p.id;
                                    paragraphsInRange.push({
                                        id: p.id,
                                        text: p.text,
                                        sectionSlug: slug,
                                        sectionTitle: section.title,
                                        isFirstOfSection: isFirstOfSection
                                    });
                                }
                            }
                        }
                        
                        // Sort by paragraph ID to ensure correct order
                        paragraphsInRange.sort((a, b) => a.id - b.id);
                        
                        // Render with section headers when section changes (including first)
                        let currentSection = null;
                        for (const p of paragraphsInRange) {
                            if (p.sectionSlug !== currentSection) {
                                // New section - add header with (continued) if not starting at first paragraph
                                const continued = !p.isFirstOfSection ? ' (continued)' : '';
                                html += `<h4 class="mtb-inline-header">${p.sectionTitle}${continued}</h4>`;
                                currentSection = p.sectionSlug;
                            }
                            html += `<p>${p.text}</p>`;
                        }
                        
                        // Hide the black title element
                        const titleEl = container.parentElement.querySelector('.root-text-title');
                        if (titleEl) titleEl.style.display = 'none';
                    }
                    // New format: ranges array with section + startParagraph/endParagraph
                    else if (cls.mtb?.ranges) {
                        console.log('Processing MTB ranges:', cls.mtb.ranges);
                        for (const range of cls.mtb.ranges) {
                            console.log('Looking for section:', range.section);
                            const section = mtbData.sections[range.section];
                            if (section) {
                                console.log('Found section with', section.paragraphs.length, 'paragraphs');
                                const paragraphs = section.paragraphs;
                                const start = range.startParagraph || 1;
                                const end = range.endParagraph || 9999;
                                console.log('Filtering paragraphs from', start, 'to', end);
                                for (const p of paragraphs) {
                                    if (p.id >= start && p.id <= end) {
                                        html += `<p>${p.text}</p>`;
                                    }
                                }
                            } else {
                                console.warn('Section not found:', range.section);
                            }
                        }
                    }
                    // Old reference format: sections array (full sections)
                    else if (cls.mtb?.sections) {
                        for (const sectionSlug of cls.mtb.sections) {
                            const section = mtbData.sections[sectionSlug];
                            if (section) {
                                const paragraphs = section.paragraphs;
                                const start = cls.mtb.startParagraph || 0;
                                const end = cls.mtb.endParagraph || 9999;
                                for (const p of paragraphs) {
                                    if (p.id >= start && p.id <= end) {
                                        html += `<p>${p.text}</p>`;
                                    }
                                }
                            }
                        }
                    }
                    
                    container.innerHTML = html || '<p class="no-content">Text not found</p>';
                    content.dataset.mtbLoaded = 'true';
                }
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '+';
            }
        }
        
        // Toggle Shantideva section with lazy loading from references
        async function toggleShantidevaSection(el, classId) {
            const content = el.nextElementSibling;
            const toggle = el.querySelector('.toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '‚àí';
                
                // Load content if not already loaded
                if (content.dataset.shantidevaLoaded !== 'true') {
                    const cls = classesData.find(c => c.id === classId);
                    const container = document.getElementById(`shantideva-content-${classId}`);
                    
                    // If content already embedded, mark as loaded
                    if (cls.shantideva?.content) {
                        content.dataset.shantidevaLoaded = 'true';
                        return;
                    }
                    
                    // Otherwise load from references
                    if (cls.shantideva?.chapter) {
                        const shantidevaData = await loadShantidevaText();
                        if (shantidevaData) {
                            const chapter = shantidevaData.chapters[cls.shantideva.chapter.toString()];
                            if (chapter) {
                                const start = cls.shantideva.startVerse || 1;
                                const end = cls.shantideva.endVerse || 999;
                                
                                // Add chapter header inline
                                let html = `<h4 class="mtb-inline-header">Chapter ${cls.shantideva.chapter}, Verses ${start}-${end}</h4>`;
                                
                                for (let v = start; v <= end; v++) {
                                    const verse = chapter.verses[v.toString()];
                                    if (verse) {
                                        html += `<p><strong>(${v})</strong> ${verse.replace(/\n/g, '<br>')}</p>`;
                                    }
                                }
                                container.innerHTML = html || '<p class="no-content">Verses not found</p>';
                                
                                // Hide the black title
                                const titleEl = container.parentElement.querySelector('.root-text-title');
                                if (titleEl) titleEl.style.display = 'none';
                            }
                        }
                    }
                    content.dataset.shantidevaLoaded = 'true';
                }
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '+';
            }
        }
        
        // Toggle Preview section with lazy loading from references
        async function togglePreviewSection(el, classId) {
            const content = el.nextElementSibling;
            const toggle = el.querySelector('.toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '‚àí';
                
                // Load content if not already loaded
                if (content.dataset.previewLoaded !== 'true') {
                    const cls = classesData.find(c => c.id === classId);
                    const container = document.getElementById(`preview-content-${classId}`);
                    
                    // If content already embedded, mark as loaded
                    if (cls.preview?.content) {
                        content.dataset.previewLoaded = 'true';
                        return;
                    }
                    
                    // Load from references
                    const mtbData = await loadMTBText();
                    if (!mtbData) {
                        container.innerHTML = '<p class="no-content">Could not load text</p>';
                        content.dataset.previewLoaded = 'true';
                        return;
                    }
                    
                    let html = '';
                    let autoTitle = '';
                    
                    // Simplest format: just startParagraph and endParagraph
                    if (cls.preview?.startParagraph && !cls.preview?.ranges && !cls.preview?.sections) {
                        const start = cls.preview.startParagraph;
                        const end = cls.preview.endParagraph || start;
                        
                        // Build ordered list of paragraphs with their sections
                        const paragraphsInRange = [];
                        for (const [slug, section] of Object.entries(mtbData.sections)) {
                            for (const p of section.paragraphs) {
                                if (p.id >= start && p.id <= end) {
                                    // Check if this is the first paragraph of the section
                                    const isFirstOfSection = section.paragraphs[0]?.id === p.id;
                                    paragraphsInRange.push({
                                        id: p.id,
                                        text: p.text,
                                        sectionSlug: slug,
                                        sectionTitle: section.title,
                                        isFirstOfSection: isFirstOfSection
                                    });
                                }
                            }
                        }
                        
                        // Sort by paragraph ID to ensure correct order
                        paragraphsInRange.sort((a, b) => a.id - b.id);
                        
                        // Render with section headers when section changes (including first)
                        let currentSection = null;
                        for (const p of paragraphsInRange) {
                            if (p.sectionSlug !== currentSection) {
                                // New section - add header with (continued) if not starting at first paragraph
                                const continued = !p.isFirstOfSection ? ' (continued)' : '';
                                html += `<h4 class="mtb-inline-header">${p.sectionTitle}${continued}</h4>`;
                                currentSection = p.sectionSlug;
                            }
                            html += `<p>${p.text}</p>`;
                        }
                        
                        // Hide the black title element
                        const titleEl = container.parentElement.querySelector('.root-text-title');
                        if (titleEl) titleEl.style.display = 'none';
                    }
                    // New format: ranges array with section + startParagraph/endParagraph
                    else if (cls.preview?.ranges) {
                        for (const range of cls.preview.ranges) {
                            const section = mtbData.sections[range.section];
                            if (section) {
                                const paragraphs = section.paragraphs;
                                const start = range.startParagraph || 1;
                                const end = range.endParagraph || 9999;
                                for (const p of paragraphs) {
                                    if (p.id >= start && p.id <= end) {
                                        html += `<p>${p.text}</p>`;
                                    }
                                }
                            }
                        }
                    }
                    // Old reference format: sections array (full sections)
                    else if (cls.preview?.sections) {
                        for (const sectionSlug of cls.preview.sections) {
                            const section = mtbData.sections[sectionSlug];
                            if (section) {
                                for (const p of section.paragraphs) {
                                    html += `<p>${p.text}</p>`;
                                }
                            }
                        }
                    }
                    
                    container.innerHTML = html || '<p class="no-content">Preview not found</p>';
                    content.dataset.previewLoaded = 'true';
                }
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '+';
            }
        }
        
        // Render practice steps
        function renderPracticeSteps(steps) {
            if (!steps || steps.length === 0) {
                return '<p class="no-content">Practice to be added</p>';
            }
            return `<ul class="practice-steps">${steps.map(s => `<li>${s}</li>`).join('')}</ul>`;
        }
        
        // Render commentary points
        function renderCommentary(points) {
            if (!points || points.length === 0) {
                return '<p class="no-content">Commentary to be added</p>';
            }
            return `<div class="commentary-container">` + points.map(point => `
                <div class="commentary-point">
                    <h4>${point.title}</h4>
                    ${point.content.map(p => `<p>${p}</p>`).join('')}
                    ${point.quote ? `<div class="kk-quote">${point.quote}</div>` : ''}
                </div>
            `).join('') + `</div>`;
        }
        
        // Render root text content
        function renderRootText(text) {
            if (!text) {
                return '<p class="no-content">Text to be added</p>';
            }
            // Handle both string and array formats
            if (Array.isArray(text)) {
                return text.map(p => `<p>${p}</p>`).join('');
            }
            return text;
        }
        
        // Render transcript session
        function renderTranscriptSession(segments) {
            return segments.map(seg => {
                const isKK = seg.speaker === 'Kadam Kyle';
                return `
                    <div class="transcript-segment ${isKK ? 'kk' : ''}">
                        <div class="transcript-meta">
                            <span class="transcript-speaker">${seg.speaker}</span>
                            <span class="transcript-time">[${seg.time}]</span>
                        </div>
                        <div class="transcript-text">${seg.text.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Render prayers placeholder
        function renderPrayersNote(prayers) {
            if (!prayers) return '';
            if (prayers.text) {
                return `
                    <div class="transcript-prayers-wrapper" onclick="toggleTranscriptSubsection(this)">
                        <div class="transcript-prayers">
                            <div class="transcript-prayers-header">
                                <div class="transcript-prayers-label">Chanted Prayers [${prayers.time}]</div>
                                <span class="toggle">+</span>
                            </div>
                            <div class="transcript-subsection-content collapsed">
                                <div class="transcript-prayers-text">${prayers.text.replace(/\n/g, '<br>')}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            return `
                <div class="transcript-prayers">
                    <div class="transcript-prayers-label">Chanted Prayers [${prayers.time}]</div>
                    <div class="transcript-prayers-note">${prayers.note || '[Prayers]'}</div>
                </div>
            `;
        }
        
        // Render a collapsible transcript subsection
        function renderCollapsibleSubsection(title, segments, startCollapsed = true) {
            if (!segments || segments.length === 0) return '';
            const collapsedClass = startCollapsed ? 'collapsed' : '';
            const toggleSymbol = startCollapsed ? '+' : '‚àí';
            return `
                <div class="transcript-subsection">
                    <div class="transcript-subsection-title" onclick="toggleTranscriptSubsection(this)">
                        <span>${title}</span>
                        <span class="toggle">${toggleSymbol}</span>
                    </div>
                    <div class="transcript-subsection-content ${collapsedClass}">
                        ${renderTranscriptSession(segments)}
                    </div>
                </div>
            `;
        }
        
        // Toggle transcript subsection
        function toggleTranscriptSubsection(el) {
            const content = el.querySelector('.transcript-subsection-content') || el.nextElementSibling;
            const toggle = el.querySelector('.toggle');
            if (content && content.classList.contains('transcript-subsection-content')) {
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    content.style.maxHeight = content.scrollHeight + 'px';
                    if (toggle) toggle.textContent = '‚àí';
                } else {
                    content.classList.add('collapsed');
                    content.style.maxHeight = '0';
                    if (toggle) toggle.textContent = '+';
                }
            }
        }
        
        // Load and render transcript
        async function loadTranscript(classId, container) {
            container.innerHTML = '<div class="transcript-loading">Loading transcript...</div>';
            
            try {
                // Try new path structure first, fall back to old
                let response = await fetch(`transcripts/transcript-${classId}.json?v=` + Date.now());
                if (!response.ok) {
                    // Try old path structure for backwards compatibility
                    response = await fetch(`transcript-${classId}.json?v=` + Date.now());
                }
                if (!response.ok) {
                    container.innerHTML = '<div class="transcript-unavailable">Transcript not yet available for this class.</div>';
                    return;
                }
                
                const transcript = await response.json();
                
                let html = '<div class="transcript-container">';
                
                // Session 1
                html += '<div class="transcript-session">';
                html += '<div class="transcript-session-title">Session 1</div>';
                
                // Class intro FIRST (if exists - pre-prayer intro)
                html += renderCollapsibleSubsection('Class Introduction', transcript.session1.classIntro);
                
                // Chanted prayers (collapsible)
                html += renderPrayersNote(transcript.session1.chantedPrayers);
                
                // Guided meditation (collapsible)
                html += renderCollapsibleSubsection('Guided Meditation', transcript.session1.guidedMeditation);
                
                // Post-meditation transition (if exists - attendance, format explanation)
                html += renderCollapsibleSubsection('Post-Meditation', transcript.session1.postMeditation);
                
                // Shantideva reading (collapsible) - comes before practice reports
                html += renderCollapsibleSubsection('Shantideva Reading', transcript.session1.shantidevaReading);
                
                // Post-reading / Class overview (collapsible) - roll call, recap, intro to sharing
                html += renderCollapsibleSubsection('Class Overview', transcript.session1.postReading);
                
                // Practice reports (collapsible) - check both old and new naming
                const practiceReportsData = transcript.session1.practiceReports || transcript.session1.teaching;
                html += renderCollapsibleSubsection('Practice Reports', practiceReportsData);
                
                // Main Teaching (collapsible)
                html += renderCollapsibleSubsection('Session 1 Teaching', transcript.session1.mainTeaching);
                
                html += '</div>';
                
                // Session 2
                html += '<div class="transcript-session">';
                html += '<div class="transcript-session-title">Session 2</div>';
                
                // Chanted prayers
                html += renderPrayersNote(transcript.session2.chantedPrayers);
                
                // Guided meditation (if present)
                html += renderCollapsibleSubsection('Guided Meditation', transcript.session2.guidedMeditation);
                
                // Teaching (collapsible)
                html += renderCollapsibleSubsection('Teaching & Discussion', transcript.session2.teaching);
                
                // Conclusion (collapsible)
                html += renderCollapsibleSubsection('Conclusion & Dedication', transcript.session2.conclusion);
                
                html += '</div>';
                
                html += '</div>';
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div class="transcript-unavailable">Transcript not yet available for this class.</div>';
            }
        }
        
        // Toggle transcript section (special handling for lazy loading)
        function toggleTranscript(el, classId) {
            const content = el.nextElementSibling;
            const toggle = el.querySelector('.toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '‚àí';
                
                // Load transcript if not already loaded
                if (content.dataset.loaded !== 'true') {
                    loadTranscript(classId, content);
                    content.dataset.loaded = 'true';
                }
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '+';
            }
        }
        
        // Render main content
        function renderContent() {
            const cls = classesData.find(c => c.id === currentClassId);
            if (!cls) {
                showError('Class not found');
                return;
            }
            
            const container = document.getElementById('mainContent');
            
            container.innerHTML = `
                <div class="class-header">
                    <div class="class-date">${cls.date}, ${cls.year || '2025'}</div>
                    <h2 class="class-title">${cls.topic}</h2>
                </div>
                
                <!-- PRACTICE -->
                <section class="section practice">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span>‚ò∏ This Week's Practice</span>
                        <span class="toggle">+</span>
                    </div>
                    <div class="section-content collapsed">
                        ${cls.practice?.title ? `<div class="practice-title">${cls.practice.title}</div>` : ''}
                        ${renderPracticeSteps(cls.practice?.steps)}
                        ${cls.practice?.quote ? `<div class="practice-quote">"${cls.practice.quote}" ‚Äî KK</div>` : ''}
                    </div>
                </section>
                
                <!-- COMMENTARY -->
                <section class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span>üìñ Kadam Kyle's Commentary</span>
                        <span class="toggle">+</span>
                    </div>
                    <div class="section-content collapsed">
                        ${renderCommentary(cls.commentary)}
                    </div>
                </section>
                
                <!-- MTB ROOT TEXT -->
                <section class="section">
                    <div class="section-header" onclick="toggleMTBSection(this, '${cls.id}')">
                        <span>üìò Meaningful to Behold</span>
                        <span class="toggle">+</span>
                    </div>
                    <div class="section-content collapsed" data-mtb-loaded="false">
                        <div class="root-text-label">Section Covered</div>
                        <div class="root-text-title">${cls.mtb?.title || 'Section title to be added'}</div>
                        <div class="root-text-content" id="mtb-content-${cls.id}">
                            ${cls.mtb?.content ? renderRootText(cls.mtb.content) : '<p class="loading-text">Loading...</p>'}
                        </div>
                    </div>
                </section>
                
                <!-- SHANTIDEVA -->
                <section class="section">
                    <div class="section-header" onclick="toggleShantidevaSection(this, '${cls.id}')">
                        <span>üìú Guide to the Bodhisattva's Way of Life</span>
                        <span class="toggle">+</span>
                    </div>
                    <div class="section-content collapsed" data-shantideva-loaded="false">
                        <div class="root-text-label">Verses Recited</div>
                        <div class="root-text-title">${cls.shantideva?.title || 'Verses to be added'}</div>
                        <div class="root-text-content" id="shantideva-content-${cls.id}">
                            ${cls.shantideva?.content ? renderRootText(cls.shantideva.content) : '<p class="loading-text">Loading...</p>'}
                        </div>
                    </div>
                </section>
                
                <!-- RECORDING -->
                <section class="section recording">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span>üéß Class Recording</span>
                        <span class="toggle">+</span>
                    </div>
                    <div class="section-content collapsed">
                        ${cls.recording ? `<a href="${cls.recording}" target="_blank" class="recording-link">‚ñ∂ Listen to the full class recording on Google Drive</a>` : '<p class="no-content">Recording not yet available</p>'}
                    </div>
                </section>
                
                <!-- TRANSCRIPT -->
                <section class="section transcript">
                    <div class="section-header" onclick="toggleTranscript(this, '${cls.id}')">
                        <span>üìù Class Transcript</span>
                        <span class="toggle">+</span>
                    </div>
                    <div class="section-content collapsed" data-loaded="false">
                        <div class="transcript-loading">Click to load transcript...</div>
                    </div>
                </section>
                
                <!-- PREVIEW / NEXT WEEK -->
                <section class="section preview">
                    <div class="section-header" onclick="togglePreviewSection(this, '${cls.id}')">
                        <span>üëÅ Next Week's Reading</span>
                        <span class="toggle">+</span>
                    </div>
                    <div class="section-content collapsed" data-preview-loaded="false">
                        <div class="root-text-label">Preview from MTB</div>
                        <div class="root-text-title">${cls.preview?.title || 'Preview to be added'}</div>
                        <div class="root-text-content" id="preview-content-${cls.id}">
                            ${cls.preview?.content ? renderRootText(cls.preview.content) : '<p class="loading-text">Loading...</p>'}
                        </div>
                    </div>
                </section>
            `;
        }
        
        // Initialize
        loadData();
    </script>
</body>
</html>
